{% extends 'base.html' %}
{% load static %}

{% block content %}
<body class="wrapper">
  <div class="inner">
    <h2 class=" mt-4 text-black">제목 :
      {{ meeting.title }}
      <div>
        {% if request.user == meeting.user %}
          <a class="float-end btn btn-outline-primary" href="{% url 'meetings:update' meeting.pk %}">
            수정
          </a>
          <a class="float-end btn btn-outline-danger me-4" href="{% url 'meetings:delete' meeting.pk %}">
            삭제
          </a>
        {% endif %}
      </div>
    </h2>
    <p class="text-black">내용 :
      {{ meeting.content }}</p>

    <div class="my-5 text-black">
      <h4 class="fw-bold mb-3">리뷰 작성
        <a class="float-end btn btn-outline-success" href="{% url 'meetings:index' %}">목록</a>
      </h4>
      {% if request.user.is_authenticated %}
        <form action="{% url 'meetings:comment_create' meeting.pk %}" method="POST">
          {% csrf_token %}
          <input type="text" class="form-control my-4" name="content" placeholder="댓글을 달아주세요" aria-label="Username" aria-describedby="basic-addon1">
          <button class="btn btn-outline-primary ">작성</button>
        </form>
      {% endif %}
    </div>

    <div class="d-flex text-black">
      이 방에 참여한 유저들: 
      <div>
      {% for user in user_list %}
        <a class="ms-2 text-decoration-none text-black" href="{% url 'accounts:profile' meeting.pk %}">{{ user.nickname }}</a>
      {% endfor %}
      </div>
    </div>

    <form action="{% url 'meetings:detail' meeting.pk %}" method="POST" class="m-1">
      {% csrf_token %}
      <button class="btn btn-outline-light" name="belong_id" value="belong_id">
        참여
      </button>
    </form>
    {% if meeting.belong %}
    <span class="text-black">{{ meeting.belong.count }}</span>

    {% endif %}
    <small class="text-black">참여버튼을 누르시면 비밀번호 입력없이 들어올 수 있습니다.</small>

    <div class="my-3 text-black">
      댓글
    </div>

    {% for comment in comments %}
      <div>
        <p class="text-black">{{ comment.user.nickname }}</p>
      </div>
      <p class="fs-6 text-black">{{ comment.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
      <p class="text-black">{{ comment.content }}</p>

      {% if request.user == comment.user %}
        <form action="{% url 'meetings:comment_delete' meeting.pk comment.pk %}" method="POST">
          {% csrf_token %}
          <button class="btn btn-outline-danger" type="submit">삭제</button>
        </form>
      {% endif %}
      <hr>
      {% empty %}
      <p class="text-black">댓글이 없습니다.</p>
    {% endfor %}
  </div>
</body>

  {% comment %} js {% endcomment %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const form = document.querySelector("#belong-form")
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

      form.addEventListener('submit', function (event) {
        event.preventDefault()
        const userId = event.target.dataset.userId

        axios({
          method: 'post',
          url: `/accounts/${userId}/belonging/`,
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
          .then((response) => {
            const isBelonged = response.data.is_belonged
            const belongBtn = document.querySelector('#belong-form > input[type=submit]')
            if (isBelonged === true) {
              belongBtn.value = '모임참여 취소'
            } else {
              belongBtn.value = '모임참여'
            }
            // const followerCountTag = document.querySelector('#followers-count')
            // const followingCountTag = document.querySelector('#followings-count')
            // const followersCount = response.data.followers_count
            // const followingsCount = response.data.followings_count
            // followerCountTag.innerText = followersCount
            // followingCountTag.innerText = followingsCount
          })
          .catch((error) => {
            console.log(error.response)
          })
      })
    </script>

    <style>
      .wrapper {
        min-height: 100vh;
        background-image: url("/static/images/글생성배경.jpg");
        background-size: cover;
      }
      .inner {
        max-width: 1000px;
        margin: auto;
        border-radius: 50px;
        background: #f1f4f4;
        border: 10px solid #0d99d2;
        padding: 77px 99px 87px;
        box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.2);
        -webkit-box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.2);
        -ms-box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.2);
        -o-box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.2);
      }
    </style>
{% endblock content %}
